import { Command } from "commander";
import figlet from "figlet";
import axios from "axios";
import axiosThrottle from 'axios-request-throttle';

axiosThrottle.use(axios, { requestsPerSecond: 5 });

export const simpleDVT = new Command("simple-dvt");

simpleDVT
  .version("0.0.1", "-v, --vers", "output the current version")
  .action(async () => {
    console.info(figlet.textSync("Simple DVT Stats"));
    // spinnerInfo(`Obtaining Lido operators\n`);

    let clusters = [
      "35,44,118,129,151,192,195",
      "24,32,47,55,83,104,108",
      "76,101,114,127,145,188,208",
      "68,81,95,97,116,123,162",
      "43,104,139,178,182,203,209",
      "19,21,33,60,185,212,223",
      "42,59,103,125,183,184,189",
      "32,35,61,65,66,77,86",
      "140,157,172,175,193,202,214",
      "29,45,48,53,62,117,205",
      "32,85,97,121,199,219,237",
      "11,28,54,56,70,110,120",
      "19,22,25,82,119,156,226",
      "36,64,80,113,122,144,178",
      "16,27,86,90,200,204,214",
      "72,77,91,95,161,228,229",
      "11,37,68,131,134,137,141",
      "75,100,107,132,154,175,197",
      "112,129,130,143,163,183,191",
      "30,49,52,69,110,149,206",
      "54,101,140,177,194,200,212",
      "20,45,94,126,151,198,230",
      "21,30,67,84,98,196,218",
      "26,40,46,56,58,135,148",
      "93,109,167,173,217,220,222",
      "60,81,105,153,193,202,207",
      "26,41,79,111,156,159,174",
      "17,35,66,87,102,114,181",
      "92,98,106,136,173,213,227",
      "23,70,99,103,129,152,171",
      "11,41,69,179,190,208,217",
      "23,63,118,142,187,210,215",
    ];


    // This is hardcoded to avoid spamming the e2m API
    let simpleDVTValidators = [ "1555982", "1555983", "1555984", "1555985", "1556169", "1588518", "1588519", "1588520", "1588521", "1588522",
    "1588523", "1588668", "1588669", "1588670", "1588671", "1588672", "1588818", "1588819", "1588820", "1588821",
    "1588822", "1588968", "1588969", "1588970", "1588971", "1588972", "1589118", "1589119", "1589120", "1589121",
    "1589122", "1589268", "1589269", "1589270", "1589271", "1589272", "1589273", "1589418", "1589419", "1589420",
    "1589421", "1589422", "1589568", "1589569", "1589570", "1589571", "1589572", "1589719", "1589720", "1589721",
    "1555986", "1555987", "1555988", "1555989", "1556170", "1588524", "1588525", "1588526", "1588527", "1588528",
    "1588529", "1588673", "1588674", "1588675", "1588676", "1588677", "1588823", "1588824", "1588825", "1588826",
    "1588827", "1588973", "1588974", "1588975", "1588976", "1588977", "1589123", "1589124", "1589125", "1589126",
    "1589127", "1589274", "1589275", "1589276", "1589277", "1589278", "1589423", "1589424", "1589425", "1589426",
    "1589427", "1589428", "1589573", "1589574", "1589575", "1589576", "1589577", "1589722", "1589723", "1589724",
    "1557633", "1557634", "1557635", "1557636", "1557637", "1595541", "1595542", "1595543", "1595544", "1595545",
    "1595546", "1595547", "1595548", "1595549", "1595550", "1595551", "1595552", "1595553", "1595554", "1595555",
    "1595556", "1595557", "1595558", "1595559", "1595560", "1595561", "1595562", "1595563", "1595564", "1595565",
    "1595566", "1595567", "1595568", "1595569", "1595570", "1595571", "1595572", "1595573", "1595574", "1595575",
    "1595576", "1595577", "1595578", "1595579", "1595580", "1595581", "1595582", "1595583", "1595584", "1595585",
    "1555990", "1555991", "1555992", "1555993", "1556171", "1588530", "1588531", "1588532", "1588533", "1588534",
    "1588535", "1588678", "1588679", "1588680", "1588681", "1588682", "1588828", "1588829", "1588830", "1588831",
    "1588832", "1588978", "1588979", "1588980", "1588981", "1588982", "1589128", "1589129", "1589130", "1589131",
    "1589132", "1589279", "1589280", "1589281", "1589282", "1589283", "1589429", "1589430", "1589431", "1589432",
    "1589433", "1589434", "1589578", "1589579", "1589580", "1589581", "1589582", "1589725", "1589726", "1589727",
    "1555994", "1555995", "1555996", "1555997", "1556172", "1588536", "1588537", "1588538", "1588539", "1588540",
    "1588541", "1588683", "1588684", "1588685", "1588686", "1588687", "1588833", "1588834", "1588835", "1588836",
    "1588837", "1588983", "1588984", "1588985", "1588986", "1588987", "1589133", "1589134", "1589135", "1589136",
    "1589137", "1589284", "1589285", "1589286", "1589287", "1589288", "1589435", "1589436", "1589437", "1589438",
    "1589439", "1589440", "1589583", "1589584", "1589585", "1589586", "1589587", "1589728", "1589729", "1589730",
    "1555998", "1555999", "1556000", "1556001", "1556173", "1588542", "1588543", "1588544", "1588545", "1588546",
    "1588547", "1588688", "1588689", "1588690", "1588691", "1588692", "1588838", "1588839", "1588840", "1588841",
    "1588842", "1588988", "1588989", "1588990", "1588991", "1588992", "1589138", "1589139", "1589140", "1589141",
    "1589142", "1589289", "1589290", "1589291", "1589292", "1589293", "1589441", "1589442", "1589443", "1589444",
    "1589445", "1589446", "1589588", "1589589", "1589590", "1589591", "1589592", "1589731", "1589732", "1589733",
    "1556002", "1556003", "1556004", "1556174", "1556175", "1588548", "1588549", "1588550", "1588551", "1588552",
    "1588693", "1588694", "1588695", "1588696", "1588697", "1588698", "1588843", "1588844", "1588845", "1588846",
    "1588847", "1588993", "1588994", "1588995", "1588996", "1588997", "1589143", "1589144", "1589145", "1589146",
    "1589147", "1589294", "1589295", "1589296", "1589297", "1589298", "1589447", "1589448", "1589449", "1589450",
    "1589451", "1589452", "1589593", "1589594", "1589595", "1589596", "1589597", "1589734", "1589735", "1589736",
    "1556005", "1556006", "1556007", "1556176", "1556177", "1588553", "1588554", "1588555", "1588556", "1588557",
    "1588699", "1588700", "1588701", "1588702", "1588703", "1588704", "1588848", "1588849", "1588850", "1588851",
    "1588852", "1588998", "1588999", "1589000", "1589001", "1589002", "1589148", "1589149", "1589150", "1589151",
    "1589152", "1589299", "1589300", "1589301", "1589302", "1589303", "1589453", "1589454", "1589455", "1589456",
    "1589457", "1589598", "1589599", "1589600", "1589601", "1589602", "1589603", "1589737", "1589738", "1589739",
    "1556008", "1556009", "1556010", "1556178", "1556179", "1588558", "1588559", "1588560", "1588561", "1588562",
    "1588705", "1588706", "1588707", "1588708", "1588709", "1588710", "1588853", "1588854", "1588855", "1588856",
    "1588857", "1589003", "1589004", "1589005", "1589006", "1589007", "1589153", "1589154", "1589155", "1589156",
    "1589157", "1589304", "1589305", "1589306", "1589307", "1589308", "1589458", "1589459", "1589460", "1589461",
    "1589462", "1589604", "1589605", "1589606", "1589607", "1589608", "1589609", "1589740", "1589741", "1589742",
    "1556011", "1556012", "1556013", "1556180", "1556181", "1588563", "1588564", "1588565", "1588566", "1588567",
    "1588711", "1588712", "1588713", "1588714", "1588715", "1588716", "1588858", "1588859", "1588860", "1588861",
    "1588862", "1589008", "1589009", "1589010", "1589011", "1589012", "1589158", "1589159", "1589160", "1589161",
    "1589162", "1589309", "1589310", "1589311", "1589312", "1589313", "1589463", "1589464", "1589465", "1589466",
    "1589467", "1589610", "1589611", "1589612", "1589613", "1589614", "1589615", "1589743", "1589744", "1589745",
    "1556014", "1556015", "1556016", "1556182", "1556183", "1588568", "1588569", "1588570", "1588571", "1588572",
    "1588717", "1588718", "1588719", "1588720", "1588721", "1588722", "1588863", "1588864", "1588865", "1588866",
    "1588867", "1589013", "1589014", "1589015", "1589016", "1589017", "1589163", "1589164", "1589165", "1589166",
    "1589167", "1589314", "1589315", "1589316", "1589317", "1589318", "1589468", "1589469", "1589470", "1589471",
    "1589472", "1589616", "1589617", "1589618", "1589619", "1589620", "1589621", "1589746", "1589747", "1589748",
    "1556017", "1556018", "1556019", "1556184", "1556185", "1588573", "1588574", "1588575", "1588576", "1588577",
    "1588723", "1588724", "1588725", "1588726", "1588727", "1588868", "1588869", "1588870", "1588871", "1588872",
    "1588873", "1589018", "1589019", "1589020", "1589021", "1589022", "1589168", "1589169", "1589170", "1589171",
    "1589172", "1589319", "1589320", "1589321", "1589322", "1589323", "1589473", "1589474", "1589475", "1589476",
    "1589477", "1589622", "1589623", "1589624", "1589625", "1589626", "1589627", "1589749", "1589750", "1589751",
    "1556020", "1556021", "1556022", "1556186", "1556187", "1588578", "1588579", "1588580", "1588581", "1588582",
    "1588728", "1588729", "1588730", "1588731", "1588732", "1588874", "1588875", "1588876", "1588877", "1588878",
    "1588879", "1589023", "1589024", "1589025", "1589026", "1589027", "1589173", "1589174", "1589175", "1589176",
    "1589177", "1589324", "1589325", "1589326", "1589327", "1589328", "1589478", "1589479", "1589480", "1589481",
    "1589482", "1589628", "1589629", "1589630", "1589631", "1589632", "1589752", "1589753", "1589754", "1589755",
    "1556023", "1556024", "1556025", "1556188", "1556189", "1588583", "1588584", "1588585", "1588586", "1588587",
    "1588733", "1588734", "1588735", "1588736", "1588737", "1588880", "1588881", "1588882", "1588883", "1588884",
    "1588885", "1589028", "1589029", "1589030", "1589031", "1589032", "1589178", "1589179", "1589180", "1589181",
    "1589182", "1589329", "1589330", "1589331", "1589332", "1589333", "1589483", "1589484", "1589485", "1589486",
    "1589487", "1589633", "1589634", "1589635", "1589636", "1589637", "1589756", "1589757", "1589758", "1589759",
    "1557638", "1557639", "1557640", "1557641", "1557642", "1588588", "1588589", "1588590", "1588591", "1588592",
    "1588738", "1588739", "1588740", "1588741", "1588742", "1588886", "1588887", "1588888", "1588889", "1588890",
    "1588891", "1589033", "1589034", "1589035", "1589036", "1589037", "1589183", "1589184", "1589185", "1589186",
    "1589187", "1589334", "1589335", "1589336", "1589337", "1589338", "1589488", "1589489", "1589490", "1589491",
    "1589492", "1589638", "1589639", "1589640", "1589641", "1589642", "1589760", "1589761", "1589762", "1589763",
    "1557643", "1557644", "1557645", "1557646", "1557647", "1588593", "1588594", "1588595", "1588596", "1588597",
    "1588743", "1588744", "1588745", "1588746", "1588747", "1588892", "1588893", "1588894", "1588895", "1588896",
    "1588897", "1589038", "1589039", "1589040", "1589041", "1589042", "1589188", "1589189", "1589190", "1589191",
    "1589192", "1589339", "1589340", "1589341", "1589342", "1589343", "1589493", "1589494", "1589495", "1589496",
    "1589497", "1589643", "1589644", "1589645", "1589646", "1589647", "1589764", "1589765", "1589766", "1589767",
    "1556026", "1556027", "1556028", "1556190", "1556191", "1588598", "1588599", "1588600", "1588601", "1588602",
    "1588748", "1588749", "1588750", "1588751", "1588752", "1588898", "1588899", "1588900", "1588901", "1588902",
    "1589043", "1589044", "1589045", "1589046", "1589047", "1589048", "1589193", "1589194", "1589195", "1589196",
    "1589197", "1589344", "1589345", "1589346", "1589347", "1589348", "1589498", "1589499", "1589500", "1589501",
    "1589502", "1589648", "1589649", "1589650", "1589651", "1589652", "1589768", "1589769", "1589770", "1589771",
    "1556029", "1556030", "1556031", "1556192", "1556193", "1588603", "1588604", "1588605", "1588606", "1588607",
    "1588753", "1588754", "1588755", "1588756", "1588757", "1588903", "1588904", "1588905", "1588906", "1588907",
    "1589049", "1589050", "1589051", "1589052", "1589053", "1589054", "1589198", "1589199", "1589200", "1589201",
    "1589202", "1589349", "1589350", "1589351", "1589352", "1589353", "1589503", "1589504", "1589505", "1589506",
    "1589507", "1589653", "1589654", "1589655", "1589656", "1589657", "1589772", "1589773", "1589774", "1589775",
    "1556032", "1556033", "1556034", "1556194", "1556195", "1588608", "1588609", "1588610", "1588611", "1588612",
    "1588758", "1588759", "1588760", "1588761", "1588762", "1588908", "1588909", "1588910", "1588911", "1588912",
    "1589055", "1589056", "1589057", "1589058", "1589059", "1589060", "1589203", "1589204", "1589205", "1589206",
    "1589207", "1589354", "1589355", "1589356", "1589357", "1589358", "1589508", "1589509", "1589510", "1589511",
    "1589512", "1589658", "1589659", "1589660", "1589661", "1589662", "1589776", "1589777", "1589778", "1589779",
    "1557648", "1557649", "1557650", "1557651", "1557652", "1588613", "1588614", "1588615", "1588616", "1588617",
    "1588763", "1588764", "1588765", "1588766", "1588767", "1588913", "1588914", "1588915", "1588916", "1588917",
    "1589061", "1589062", "1589063", "1589064", "1589065", "1589066", "1589208", "1589209", "1589210", "1589211",
    "1589212", "1589359", "1589360", "1589361", "1589362", "1589363", "1589513", "1589514", "1589515", "1589516",
    "1589517", "1589663", "1589664", "1589665", "1589666", "1589667", "1589780", "1589781", "1589782", "1589783",
    "1557653", "1557654", "1557655", "1557656", "1557657", "1588618", "1588619", "1588620", "1588621", "1588622",
    "1588768", "1588769", "1588770", "1588771", "1588772", "1588918", "1588919", "1588920", "1588921", "1588922",
    "1589067", "1589068", "1589069", "1589070", "1589071", "1589072", "1589213", "1589214", "1589215", "1589216",
    "1589217", "1589364", "1589365", "1589366", "1589367", "1589368", "1589518", "1589519", "1589520", "1589521",
    "1589522", "1589668", "1589669", "1589670", "1589671", "1589672", "1589784", "1589785", "1589786", "1589787",
    "1557658", "1557659", "1557660", "1557661", "1557662", "1595586", "1595587", "1595588", "1595589", "1595590",
    "1595591", "1595592", "1595593", "1595594", "1595595", "1595596", "1595597", "1595598", "1595599", "1595600",
    "1595601", "1595602", "1595603", "1595604", "1595605", "1595606", "1595607", "1595608", "1595609", "1595610",
    "1595611", "1595612", "1595613", "1595614", "1595615", "1595616", "1595617", "1595618", "1595619", "1595620",
    "1595621", "1595622", "1595623", "1595624", "1595625", "1595626", "1595627", "1595628", "1595629", "1595630",
    "1556035", "1556036", "1556037", "1556196", "1556197", "1588623", "1588624", "1588625", "1588626", "1588627",
    "1588773", "1588774", "1588775", "1588776", "1588777", "1588923", "1588924", "1588925", "1588926", "1588927",
    "1589073", "1589074", "1589075", "1589076", "1589077", "1589218", "1589219", "1589220", "1589221", "1589222",
    "1589223", "1589369", "1589370", "1589371", "1589372", "1589373", "1589523", "1589524", "1589525", "1589526",
    "1589527", "1589673", "1589674", "1589675", "1589676", "1589677", "1589788", "1589789", "1589790", "1589791",
    "1556038", "1556039", "1556040", "1556198", "1556199", "1588628", "1588629", "1588630", "1588631", "1588632",
    "1588778", "1588779", "1588780", "1588781", "1588782", "1588928", "1588929", "1588930", "1588931", "1588932",
    "1589078", "1589079", "1589080", "1589081", "1589082", "1589224", "1589225", "1589226", "1589227", "1589228",
    "1589229", "1589374", "1589375", "1589376", "1589377", "1589378", "1589528", "1589529", "1589530", "1589531",
    "1589532", "1589678", "1589679", "1589680", "1589681", "1589682", "1589792", "1589793", "1589794", "1589795",
    "1556041", "1556042", "1556043", "1556200", "1556201", "1588633", "1588634", "1588635", "1588636", "1588637",
    "1588783", "1588784", "1588785", "1588786", "1588787", "1588933", "1588934", "1588935", "1588936", "1588937",
    "1589083", "1589084", "1589085", "1589086", "1589087", "1589230", "1589231", "1589232", "1589233", "1589234",
    "1589235", "1589379", "1589380", "1589381", "1589382", "1589383", "1589533", "1589534", "1589535", "1589536",
    "1589537", "1589683", "1589684", "1589685", "1589686", "1589687", "1589796", "1589797", "1589798", "1589799",
    "1556044", "1556045", "1556046", "1556202", "1556203", "1588638", "1588639", "1588640", "1588641", "1588642",
    "1588788", "1588789", "1588790", "1588791", "1588792", "1588938", "1588939", "1588940", "1588941", "1588942",
    "1589088", "1589089", "1589090", "1589091", "1589092", "1589236", "1589237", "1589238", "1589239", "1589240",
    "1589241", "1589384", "1589385", "1589386", "1589387", "1589388", "1589538", "1589539", "1589540", "1589541",
    "1589542", "1589688", "1589689", "1589690", "1589691", "1589692", "1589800", "1589801", "1589802", "1589803",
    "1556047", "1556048", "1556049", "1556204", "1556205", "1588643", "1588644", "1588645", "1588646", "1588647",
    "1588793", "1588794", "1588795", "1588796", "1588797", "1588943", "1588944", "1588945", "1588946", "1588947",
    "1589093", "1589094", "1589095", "1589096", "1589097", "1589242", "1589243", "1589244", "1589245", "1589246",
    "1589247", "1589389", "1589390", "1589391", "1589392", "1589393", "1589543", "1589544", "1589545", "1589546",
    "1589547", "1589693", "1589694", "1589695", "1589696", "1589697", "1589804", "1589805", "1589806", "1589807",
    "1556050", "1556051", "1556052", "1556206", "1556207", "1588648", "1588649", "1588650", "1588651", "1588652",
    "1588798", "1588799", "1588800", "1588801", "1588802", "1588948", "1588949", "1588950", "1588951", "1588952",
    "1589098", "1589099", "1589100", "1589101", "1589102", "1589248", "1589249", "1589250", "1589251", "1589252",
    "1589394", "1589395", "1589396", "1589397", "1589398", "1589399", "1589548", "1589549", "1589550", "1589551",
    "1589552", "1589698", "1589699", "1589700", "1589701", "1589702", "1589808", "1589809", "1589810", "1589811",
    "1556053", "1556054", "1556055", "1556208", "1556209", "1588653", "1588654", "1588655", "1588656", "1588657",
    "1588803", "1588804", "1588805", "1588806", "1588807", "1588953", "1588954", "1588955", "1588956", "1588957",
    "1589103", "1589104", "1589105", "1589106", "1589107", "1589253", "1589254", "1589255", "1589256", "1589257",
    "1589400", "1589401", "1589402", "1589403", "1589404", "1589405", "1589553", "1589554", "1589555", "1589556",
    "1589557", "1589703", "1589704", "1589705", "1589706", "1589707", "1589812", "1589813", "1589814", "1589815",
    "1556056", "1556057", "1556058", "1556210", "1556211", "1588658", "1588659", "1588660", "1588661", "1588662",
    "1588808", "1588809", "1588810", "1588811", "1588812", "1588958", "1588959", "1588960", "1588961", "1588962",
    "1589108", "1589109", "1589110", "1589111", "1589112", "1589258", "1589259", "1589260", "1589261", "1589262",
    "1589406", "1589407", "1589408", "1589409", "1589410", "1589411", "1589558", "1589559", "1589560", "1589561",
    "1589562", "1589708", "1589709", "1589710", "1589711", "1589712", "1589816", "1589817", "1589818", "1589819",
    "1556059", "1556060", "1556061", "1556212", "1556213", "1588663", "1588664", "1588665", "1588666", "1588667",
    "1588813", "1588814", "1588815", "1588816", "1588817", "1588963", "1588964", "1588965", "1588966", "1588967",
    "1589113", "1589114", "1589115", "1589116", "1589117", "1589263", "1589264", "1589265", "1589266", "1589267",
    "1589412", "1589413", "1589414", "1589415", "1589416", "1589417", "1589563", "1589564", "1589565", "1589566",
    "1589567", "1589713", "1589714", "1589715", "1589716", "1589717", "1589820", "1589821", "1589822", "1589823",
    "1556062", "1556063", "1556064", "1556214", "1556215", "1595631", "1595632", "1595633", "1595634", "1595635",
    "1595636", "1595637", "1595638", "1595639", "1595640", "1595641", "1595642", "1595643", "1595644", "1595645",
    "1595646", "1595647", "1595648", "1595649", "1595650", "1595651", "1595652", "1595653", "1595654", "1595655",
    "1595656", "1595657", "1595658", "1595659", "1595660", "1595661", "1595662", "1595663", "1595664", "1595665",
    "1595666", "1595667", "1595668", "1595669", "1595670", "1595671", "1595672", "1595673", "1595674", "1595675"
  ]

    // console.log(simpleDVTValidators?.length);
    // console.log(simpleDVTValidators);
    let validatorDataBatches: ValidatorData[] = [];
    for (let i=1;i<simpleDVTValidators?.length/200;i++){
      console.log(`Requestind data for batch number ${i}`)
      let batchValidatorData = await getBatchValidatorData(simpleDVTValidators.slice((i-1)*200,i*200));
      if (batchValidatorData)
        validatorDataBatches.push(batchValidatorData)
    }
    let uptime = 0
    let attesterEffectiveness = 0
    let totalProposed = 0
    let totalProposedDuties = 0
    for (let batch of validatorDataBatches) {
      uptime += batch.uptime / validatorDataBatches.length
      attesterEffectiveness += batch.attesterEffectiveness / validatorDataBatches.length
      totalProposed += batch.proposedCount
      totalProposedDuties += batch.proposerDutiesCount
    }
    console.log(`Total Validators uptime: ${uptime}`)
    console.log(`Total Validators Effectiveness: ${attesterEffectiveness}`)
    console.log(`Total Validators Proposal ratio: ${totalProposed/totalProposedDuties}`)
  });

async function getClusterValidators(cluster: string): Promise<string[]> {
  console.log(
    `Obtaining Lido operators\n${process.env.E2M_CLUSTER_API}${cluster}`
  );
  let response = await axios({
    method: "GET",
    url: `${process.env.E2M_CLUSTER_API}${cluster}`,
    headers: {
      "content-type": "application/json",
    },
  });

  // console.log(response)
  if (response.status !== 200) throw Error("Request did not return OK");
  // generate a map with {id: {operator info}}
  // console.log(response.data.Data);
  let validators = Object.keys(response.data.Data);
  return validators;
}

type ValidatorData = {
  uptime: number,
  attesterEffectiveness: number,
  proposedCount: number,
  proposerDutiesCount: number,
  proposerEffectiveness: number,
}

async function getBatchValidatorData(validators: string[]): Promise<ValidatorData | undefined> {

  let validatorIndices = validators.join("&indices=")
  let url = `${process.env.RATED_API}${process.env.RATED_API_PARAMS}${validatorIndices}`
  // console.log(url)
  
  let response;
  try {

    response = await axios({
      method: "GET",
      url: url,
      headers: {
        "content-type": "application/json",
        "X-Rated-Network": "holesky",
        "Authorization": `Bearer ${process.env.RATED_AUTH}`
      },
    });

    if (response.status !== 200) throw Error("Request did not return OK");
    // generate a map with {id: {operator info}}
    let batchValidatorData = response.data.data[0];
    // console.log(batchValidatorData)
    return batchValidatorData;
  } catch (err) {
    // spinnerError();
    // stopSpinner();
    console.error("ERROR DURING AXIOS REQUEST");
    // console.error(err)
  }
}
